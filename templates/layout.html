{{define "base"}}
<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{{template "title" .}}</title>

    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">

    <link rel="apple-touch-icon" sizes="180x180" href="/public/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/public/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/public/favicon-16x16.png">
    <link rel="manifest" href="/public/site.webmanifest">
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 48
        }
    </style>

    <style>
        .table tbody tr.active,
        .table.table-striped tbody tr.active {
            background: #98b4f86b;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>
    <script>
        var socket;
        window.addEventListener('DOMContentLoaded', () => {
            socket = new WebSocket("wss://" + window.location.host + "/echo?t={{ .csrfField }}");
            socket.onopen = function () {
                console.log("Status: Connected\n");
            };
            socket.onmessage = function (e) {
                var msg = JSON.parse(e.data);
                if (!msg) {
                    console.warn("empty message:", e.data);
                    return;
                }
                console.log("Message:", msg.command);
                console.log(msg);
                switch (msg.command) {
                    case "player.play":
                        player_title.innerHTML = msg.data.title;
                        player_thumb.setAttribute("src", "/" + msg.data.thumb);
                        stop_btn.removeAttribute("hidden", null);
                        play_btn.setAttribute("onclick", "wsplay(event, '" + msg.data.id + "')");
                        break;
                    case "player.stop":
                        play_btn.removeAttribute("hidden", null);
                        break;
                    case "download":
                        // ignore
                        break;
                    case "download.done":
                        window.location.href = '/songs';
                        // TODO: stop loading
                        break;
                    case "toast":
                        var el = document.getElementById("liveToast");
                        el.querySelector(".me-auto").innerHTML = msg.data.title || ''
                        el.querySelector(".text-muted").innerHTML = msg.data.subtitle || ''
                        el.querySelector(".toast-body").innerHTML = msg.data.text || ''
                        var toast = new bootstrap.Toast(el, {});
                        toast.show();
                        break;
                    case "error":
                        console.error(msg);
                        alert(e.error);
                        break;
                     case "ping":
                        send({
                            command: "pong",
                        });
                        break;
                    default:
                        console.error("Unknown command:", msg.command);
                        break;
                }
            };
        });

        function wsplay(e, id) {
            console.log("on play....");
            e.stopPropagation();
            play_btn.setAttribute("hidden", null);
            stop_btn.setAttribute("hidden", null);
            send({
                command: "player.play",
                data: {
                    song_id: id
                }
            });
        }
        function wsstop() {
            send({
                command: "player.stop"
            });
            if (play_btn) {
                play_btn.setAttribute("hidden", null);
            }
            if (stop_btn) {
                stop_btn.setAttribute("hidden", null);
            }
        }

        function send(msg) {
            if (!socket) {
                console.warn("no socket")
                return false;
            }
            if (!socket.OPEN) {
                console.warn("socket not open")
                return false;
            }
            if (socket.CONNECTING) {
                console.warn("socket connecting")
                return false;
            }
            if (!msg || !msg.command) {
                return false;
            }
            console.log(msg);
            try {
                socket.send(JSON.stringify(msg));
            } catch (error) {
                console.warn(error);
            }
            return true;
        }
    </script>
    <header>
    </header>
    <nav class="navbar navbar-expand-lg bg-light">
        {{template "nav" .}}
    </nav>
    <main>
        {{template "main" .}}
    </main>
    {{template "player" .}}
</body>

</html>
{{end}}